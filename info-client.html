<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPlay Telemetry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .header p {
            color: #888;
            font-size: 0.9rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }

        .stat h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 8px;
        }

        .stat p {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity {
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .activity-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .activity-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            flex: 1;
        }

        .activity-user {
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .activity-details {
            font-size: 0.85rem;
            color: #888;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            min-width: 60px;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .status.show {
            transform: translateX(0);
        }

        .status.success {
            background: #059669;
            color: white;
        }

        .status.error {
            background: #dc2626;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .server-info {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #888;
        }

        .server-info code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4ade80;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .activity-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .activity-time {
                text-align: left;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="status"></div>
    
    <div class="container">
        <div class="header">
            <h1>PixelPlay Telemetry</h1>
            <p>Monitor de lanzamientos en tiempo real</p>
        </div>

        <div class="stats">
            <div class="stat">
                <h3 id="totalLaunches">-</h3>
                <p>Total Lanzamientos</p>
            </div>
            <div class="stat">
                <h3 id="uniqueUsers">-</h3>
                <p>Usuarios Únicos</p>
            </div>
            <div class="stat">
                <h3 id="activeVersions">-</h3>
                <p>Versiones Activas</p>
            </div>
            <div class="stat">
                <h3 id="totalMods">-</h3>
                <p>Mods Totales</p>
            </div>
        </div>

        <div class="activity">
            <div class="activity-header">
                <h2>Actividad Reciente</h2>
            </div>
            <div class="activity-list" id="activityList">
                <div class="empty-state">
                    <div class="icon">📊</div>
                    <p>Esperando datos de telemetría...</p>
                </div>
            </div>
        </div>

        <div class="server-info">
            <strong>Endpoint:</strong> <code>POST /telemetry</code><br>
            <strong>Puerto:</strong> <code>3000</code><br>
            <strong>Discord Webhook:</strong> Configurado ✓
        </div>
    </div>

    <script>
        // Configuración
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1326623918664192114/-td-9pyBub9d7Fbki8o4f0Ifm3A-rG2EZ2WPYZ6ULjVahf3sHaGi-mipSyrxOzmFVx5_';
        const WS_URL = 'ws://localhost:3001';
        
        // Estado de la aplicación
        let stats = {
            totalLaunches: 0,
            uniqueUsers: new Set(),
            activeVersions: new Set(),
            totalMods: 0,
            recentActivity: []
        };

        let ws = null;

        // Funciones de utilidad
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        function updateStats() {
            document.getElementById('totalLaunches').textContent = stats.totalLaunches.toLocaleString();
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.size.toLocaleString();
            document.getElementById('activeVersions').textContent = stats.activeVersions.size.toLocaleString();
            document.getElementById('totalMods').textContent = stats.totalMods.toLocaleString();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ahora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            return date.toLocaleDateString();
        }

        function addActivity(data) {
            const activity = {
                id: data.session_id,
                timestamp: data.timestamp,
                user: data.auth.username,
                version: data.launch.version,
                mods: data.mods.count,
                system: `${data.system.platform} ${data.system.arch}`
            };

            stats.recentActivity.unshift(activity);
            if (stats.recentActivity.length > 50) {
                stats.recentActivity = stats.recentActivity.slice(0, 50);
            }

            renderActivity();
        }

        function renderActivity() {
            const activityList = document.getElementById('activityList');
            
            if (stats.recentActivity.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📊</div>
                        <p>Sin actividad reciente</p>
                    </div>
                `;
                return;
            }

            activityList.innerHTML = stats.recentActivity.map(activity => `
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-user">${activity.user}</div>
                        <div class="activity-details">
                            ${activity.version} • ${activity.mods} mods • ${activity.system}
                        </div>
                    </div>
                    <div class="activity-time">${formatTime(activity.timestamp)}</div>
                </div>
            `).join('');
        }

        async function sendToDiscord(data) {
            try {
                const embed = {
                    title: "🚀 Nuevo Lanzamiento",
                    color: 0x4ade80,
                    timestamp: new Date().toISOString(),
                    fields: [
                        {
                            name: "Usuario",
                            value: `**${data.auth.username}**`,
                            inline: true
                        },
                        {
                            name: "Versión",
                            value: `**${data.launch.version}**`,
                            inline: true
                        },
                        {
                            name: "Mods",
                            value: `**${data.mods.count}**`,
                            inline: true
                        },
                        {
                            name: "Sistema",
                            value: `${data.system.platform} ${data.system.arch}`,
                            inline: true
                        },
                        {
                            name: "Memoria",
                            value: `${data.system.totalMemory}GB`,
                            inline: true
                        },
                        {
                            name: "Autenticación",
                            value: data.auth.type === 'microsoft' ? '✅ Microsoft' : '❌ Offline',
                            inline: true
                        }
                    ],
                    footer: {
                        text: `PixelPlay • ${data.session_id.slice(0, 8)}`
                    }
                };

                const response = await fetch(DISCORD_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [embed],
                        username: "PixelPlay Telemetry"
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Discord error:', error);
                return false;
            }
        }

        function processTelemetry(data) {
            // Actualizar estadísticas
            stats.totalLaunches++;
            stats.uniqueUsers.add(data.auth.uuid);
            stats.activeVersions.add(data.launch.version);
            stats.totalMods = Math.max(stats.totalMods, data.mods.count);

            // Actualizar interfaz
            updateStats();
            addActivity(data);

            // Enviar a Discord
            sendToDiscord(data).then(success => {
                showStatus(
                    success ? '✅ Enviado a Discord' : '❌ Error Discord', 
                    success ? 'success' : 'error'
                );
            });

            showStatus('📊 Datos recibidos', 'success');
        }

        // Conexión WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    console.log('📡 Conectado al servidor de telemetría');
                    showStatus('🔗 Conectado', 'success');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'telemetry') {
                            processTelemetry(data.payload);
                        }
                    } catch (error) {
                        console.error('Error procesando mensaje:', error);
                    }
                };
                
                ws.onclose = () => {
                    console.log('🔌 Desconectado del servidor');
                    showStatus('🔌 Desconectado', 'error');
                    
                    // Reintento de conexión
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showStatus('❌ Error de conexión', 'error');
                };
                
            } catch (error) {
                console.error('Error conectando WebSocket:', error);
                showStatus('❌ Sin servidor', 'error');
                setTimeout(connectWebSocket, 5000);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            connectWebSocket();
            
            // Actualizar tiempos cada minuto
            setInterval(() => {
                if (stats.recentActivity.length > 0) {
                    renderActivity();
                }
            }, 60000);
        });

        console.log('🚀 PixelPlay Dashboard iniciado');
    </script>
</body>
</html>
