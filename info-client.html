<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPlay Telemetry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .header p {
            color: #888;
            font-size: 0.9rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            padding: 16px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc2626;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4ade80;
        }

        .status-indicator.connecting {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #ffffff;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4ade80;
        }

        .btn {
            padding: 12px 24px;
            background: #4ade80;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #22c55e;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }

        .stat h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 8px;
        }

        .stat p {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity {
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .activity-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            flex: 1;
        }

        .activity-user {
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .activity-details {
            font-size: 0.85rem;
            color: #888;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            min-width: 60px;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .status.show {
            transform: translateX(0);
        }

        .status.success {
            background: #059669;
            color: white;
        }

        .status.error {
            background: #dc2626;
            color: white;
        }

        .status.warning {
            background: #d97706;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .instructions {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h4 {
            color: #4ade80;
            margin-bottom: 12px;
        }

        .instructions ul {
            color: #888;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4ade80;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .activity-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .activity-time {
                text-align: left;
                min-width: auto;
            }

            .activity-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="status"></div>
    
    <div class="container">
        <div class="header">
            <h1>PixelPlay Telemetry Dashboard</h1>
            <p>Monitor de lanzamientos en tiempo real</p>
        </div>

        <div class="connection-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="connectionText">Configurando conexión...</span>
        </div>

        <div class="config-section">
            <h3>🔧 Configuración de Conexión</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <div class="input-group">
                    <label for="connectionType">Tipo de Conexión</label>
                    <select id="connectionType" onchange="toggleConnectionConfig()">
                        <option value="webhook">Webhook Público</option>
                        <option value="api">API REST Pública</option>
                        <option value="discord">Solo Discord</option>
                        <option value="manual">Manual/Archivo</option>
                    </select>
                </div>
                <div class="input-group" id="urlGroup">
                    <label for="serverUrl">URL del Servidor</label>
                    <input type="url" id="serverUrl" placeholder="https://tu-servidor.com/api/telemetry">
                </div>
            </div>
            <div class="input-group">
                <label for="discordWebhook">Discord Webhook (Opcional)</label>
                <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
            </div>
            <button class="btn" onclick="testConnection()">🔍 Probar Conexión</button>
        </div>

        <div class="stats">
            <div class="stat">
                <h3 id="totalLaunches">0</h3>
                <p>Total Lanzamientos</p>
            </div>
            <div class="stat">
                <h3 id="uniqueUsers">0</h3>
                <p>Usuarios Únicos</p>
            </div>
            <div class="stat">
                <h3 id="activeVersions">0</h3>
                <p>Versiones Activas</p>
            </div>
            <div class="stat">
                <h3 id="totalMods">0</h3>
                <p>Mods Totales</p>
            </div>
        </div>

        <div class="activity">
            <div class="activity-header">
                <h2>Actividad Reciente</h2>
                <button class="btn" onclick="refreshData()" style="padding: 8px 16px; font-size: 0.8rem;">
                    🔄 Actualizar
                </button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="empty-state">
                    <div class="icon">📊</div>
                    <p>Esperando datos de telemetría...</p>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h4>📋 Instrucciones de Configuración</h4>
            <ul>
                <li><strong>Webhook Público:</strong> Usa servicios como <code>webhook.site</code> o <code>ngrok</code> para exponer tu servidor local</li>
                <li><strong>API REST Pública:</strong> Conecta a un servidor público que reciba los datos de telemetría</li>
                <li><strong>Solo Discord:</strong> Los datos se enviarán únicamente a Discord (requiere webhook válido)</li>
                <li><strong>Manual:</strong> Carga datos desde un archivo JSON o ingresa datos manualmente</li>
            </ul>
            <br>
            <h4>🔧 Modificaciones Necesarias en el Script</h4>
            <ul>
                <li>Cambiar el endpoint en <code>TelemetryService</code> por la URL pública configurada aquí</li>
                <li>Agregar headers CORS si usas tu propio servidor: <code>Access-Control-Allow-Origin: *</code></li>
                <li>Considerar usar servicios como Railway, Render, o Vercel para deployar un servidor simple</li>
            </ul>
        </div>
    </div>

    <script>
        // Estado de la aplicación
        let stats = {
            totalLaunches: 0,
            uniqueUsers: new Set(),
            activeVersions: new Set(),
            totalMods: 0,
            recentActivity: []
        };

        let connectionConfig = {
            type: 'webhook',
            url: '',
            discordWebhook: '',
            polling: null
        };

        // Cargar configuración guardada
        function loadConfig() {
            const saved = localStorage.getItem('pixelplay-config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    connectionConfig = { ...connectionConfig, ...config };
                    document.getElementById('connectionType').value = config.type || 'webhook';
                    document.getElementById('serverUrl').value = config.url || '';
                    document.getElementById('discordWebhook').value = config.discordWebhook || '';
                    toggleConnectionConfig();
                } catch (e) {
                    console.warn('Error cargando configuración:', e);
                }
            }
        }

        // Guardar configuración
        function saveConfig() {
            connectionConfig.type = document.getElementById('connectionType').value;
            connectionConfig.url = document.getElementById('serverUrl').value;
            connectionConfig.discordWebhook = document.getElementById('discordWebhook').value;
            
            localStorage.setItem('pixelplay-config', JSON.stringify(connectionConfig));
        }

        // Funciones de utilidad
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const textEl = document.getElementById('connectionText');
            
            indicator.className = `status-indicator ${status}`;
            textEl.textContent = text;
        }

        function toggleConnectionConfig() {
            const type = document.getElementById('connectionType').value;
            const urlGroup = document.getElementById('urlGroup');
            
            if (type === 'discord' || type === 'manual') {
                urlGroup.style.display = 'none';
            } else {
                urlGroup.style.display = 'block';
            }
            
            updateConnectionStatus('connecting', 'Configuración actualizada');
        }

        function updateStats() {
            document.getElementById('totalLaunches').textContent = stats.totalLaunches.toLocaleString();
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.size.toLocaleString();
            document.getElementById('activeVersions').textContent = stats.activeVersions.size.toLocaleString();
            document.getElementById('totalMods').textContent = stats.totalMods.toLocaleString();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ahora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            return date.toLocaleDateString();
        }

        function addActivity(data) {
            const activity = {
                id: data.session_id || Date.now().toString(),
                timestamp: data.timestamp || new Date().toISOString(),
                user: data.auth?.username || 'Usuario Desconocido',
                version: data.launch?.version || 'N/A',
                mods: data.mods?.count || 0,
                system: `${data.system?.platform || 'unknown'} ${data.system?.arch || ''}`
            };

            stats.recentActivity.unshift(activity);
            if (stats.recentActivity.length > 50) {
                stats.recentActivity = stats.recentActivity.slice(0, 50);
            }

            renderActivity();
        }

        function renderActivity() {
            const activityList = document.getElementById('activityList');
            
            if (stats.recentActivity.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📊</div>
                        <p>Sin actividad reciente</p>
                    </div>
                `;
                return;
            }

            activityList.innerHTML = stats.recentActivity.map(activity => `
                <div class="activity-item">
                    <div class="activity-info">
                        <div class="activity-user">${activity.user}</div>
                        <div class="activity-details">
                            ${activity.version} • ${activity.mods} mods • ${activity.system}
                        </div>
                    </div>
                    <div class="activity-time">${formatTime(activity.timestamp)}</div>
                </div>
            `).join('');
        }

        async function sendToDiscord(data) {
            const webhook = connectionConfig.discordWebhook;
            if (!webhook) return false;

            try {
                const embed = {
                    title: "🚀 Nuevo Lanzamiento",
                    color: 0x4ade80,
                    timestamp: new Date().toISOString(),
                    fields: [
                        {
                            name: "Usuario",
                            value: `**${data.auth?.username || 'N/A'}**`,
                            inline: true
                        },
                        {
                            name: "Versión",
                            value: `**${data.launch?.version || 'N/A'}**`,
                            inline: true
                        },
                        {
                            name: "Mods",
                            value: `**${data.mods?.count || 0}**`,
                            inline: true
                        },
                        {
                            name: "Sistema",
                            value: `${data.system?.platform || 'unknown'} ${data.system?.arch || ''}`,
                            inline: true
                        },
                        {
                            name: "Memoria",
                            value: `${data.system?.totalMemory || 0}GB`,
                            inline: true
                        },
                        {
                            name: "Autenticación",
                            value: data.auth?.type === 'microsoft' ? '✅ Microsoft' : '❌ Offline',
                            inline: true
                        }
                    ],
                    footer: {
                        text: `PixelPlay • ${(data.session_id || 'unknown').slice(0, 8)}`
                    }
                };

                const response = await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [embed],
                        username: "PixelPlay Telemetry"
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Discord error:', error);
                return false;
            }
        }

        function processTelemetry(data) {
            // Actualizar estadísticas
            stats.totalLaunches++;
            if (data.auth?.uuid) {
                stats.uniqueUsers.add(data.auth.uuid);
            }
            if (data.launch?.version) {
                stats.activeVersions.add(data.launch.version);
            }
            if (data.mods?.count) {
                stats.totalMods = Math.max(stats.totalMods, data.mods.count);
            }

            // Actualizar interfaz
            updateStats();
            addActivity(data);

            // Enviar a Discord si está configurado
            if (connectionConfig.discordWebhook) {
                sendToDiscord(data).then(success => {
                    if (success) {
                        showStatus('✅ Enviado a Discord', 'success');
                    }
                });
            }

            showStatus('📊 Datos procesados', 'success');
            updateConnectionStatus('connected', 'Recibiendo datos');
        }

        async function testConnection() {
            saveConfig();
            
            const type = connectionConfig.type;
            const url = connectionConfig.url;
            
            updateConnectionStatus('connecting', 'Probando conexión...');
            
            try {
                if (type === 'discord') {
                    if (!connectionConfig.discordWebhook) {
                        throw new Error('Discord webhook requerido');
                    }
                    
                    const testData = {
                        session_id: 'test-connection',
                        timestamp: new Date().toISOString(),
                        auth: { username: 'Test User', type: 'offline', uuid: 'test-uuid' },
                        launch: { version: 'Test Version' },
                        mods: { count: 5 },
                        system: { platform: 'test', arch: 'x64', totalMemory: 8 }
                    };
                    
                    const success = await sendToDiscord(testData);
                    if (success) {
                        updateConnectionStatus('connected', 'Discord conectado ✓');
                        showStatus('✅ Conexión a Discord exitosa', 'success');
                    } else {
                        throw new Error('Error enviando a Discord');
                    }
                } else if (type === 'manual') {
                    updateConnectionStatus('connected', 'Modo manual activo');
                    showStatus('📝 Modo manual configurado', 'success');
                } else if (url) {
                    const response = await fetch(url, { 
                        method: 'OPTIONS',
                        headers: { 'Origin': window.location.origin }
                    });
                    
                    updateConnectionStatus('connected', 'Servidor conectado ✓');
                    showStatus('✅ Conexión exitosa', 'success');
                    startPolling();
                } else {
                    throw new Error('URL requerida');
                }
            } catch (error) {
                console.error('Error de conexión:', error);
                updateConnectionStatus('error', 'Error de conexión');
                showStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        async function refreshData() {
            if (connectionConfig.type === 'api' && connectionConfig.url) {
                try {
                    const response = await fetch(connectionConfig.url);
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        data.forEach(processTelemetry);
                    } else if (data.launches) {
                        data.launches.forEach(processTelemetry);
                    } else {
                        processTelemetry(data);
                    }
                    
                    showStatus('🔄 Datos actualizados', 'success');
                } catch (error) {
                    showStatus('❌ Error al actualizar', 'error');
                }
            }
        }

        function startPolling() {
            if (connectionConfig.polling) {
                clearInterval(connectionConfig.polling);
            }
            
            if (connectionConfig.type === 'api' && connectionConfig.url) {
                connectionConfig.polling = setInterval(refreshData, 30000); // Poll cada 30 segundos
            }
        }

        // Simular datos para demostración
        function addDemoData() {
            const demoData = {
                session_id: 'demo-' + Date.now(),
                timestamp: new Date().toISOString(),
                auth: {
                    username: 'DemoPlayer',
                    type: 'microsoft',
                    uuid: 'demo-uuid-123'
                },
                launch: {
                    version: 'PixelPlay-Demo-1.20.1'
                },
                mods: {
                    count: Math.floor(Math.random() * 50) + 1
                },
                system: {
                    platform: 'win32',
                    arch: 'x64',
                    totalMemory: 16
                }
            };
            
            processTelemetry(demoData);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            updateStats();
            toggleConnectionConfig();
            
            // Agregar datos de demostración
            setTimeout(() => {
                addDemoData();
                showStatus('📊 Datos de demostración agregados', 'warning');
            }, 2000);
            
            // Actualizar tiempos cada minuto
            setInterval(() => {
                if (stats.recentActivity.length > 0) {
                    renderActivity();
                }
            }, 60000);
        });

        // Exponer función global para testing
        window.processTelemetry = processTelemetry;
        window.addDemoData = addDemoData;

        console.log('🚀 PixelPlay Dashboard iniciado');
        console.log('💡 Usa addDemoData() para agregar datos de prueba');
        console.log('💡 Usa processTelemetry(data) para procesar datos manualmente');
    </script>
</body>
</html>
