<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio P2P F1 - Joaquín Silva #47</title>
    <!-- PeerJS CDN for signaling -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #0f0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .container { background: #111; border: 2px solid #0f0; border-radius: 8px; padding: 20px; width: 100%; max-width: 420px; text-align: center; }
        .title { font-size: 1.6em; margin-bottom: 16px; }
        .controls { margin: 20px 0; }
        input, button { font-family: inherit; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; color: #0f0; border: 1px solid #0f0; border-radius: 4px; }
        button { padding: 12px 20px; background: #0f0; color: #000; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #0c0; }
        .status { margin-top: 12px; padding: 8px; background: #222; border-left: 4px solid #0f0; }
        .audio-meter { width: 100%; height: 10px; background: #333; margin-top: 12px; overflow: hidden; }
        .meter-bar { height: 100%; background: linear-gradient(90deg, #0f0, #ff0, #f00); width: 0; transition: width 0.1s; }
        @media (max-width: 480px) {
            .container { padding: 12px; }
            button { width: 100%; margin-bottom: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Radio P2P F1 - #47 Joaquín Silva</div>
        <div class="controls">
            <button id="create-room">Crear Sala</button>
            <input id="room-id" placeholder="ID de Sala" />
            <button id="join-room">Unirse a Sala</button>
        </div>
        <div class="status" id="status">Estado: Desconectado</div>
        <div class="audio-meter"><div class="meter-bar" id="meter"></div></div>
    </div>

<script>
(async function(){
    // Inicialización P2P usando PeerJS
    const peer = new Peer({ host: '0.peerjs.com', secure: true, port: 443 });
    let localStream, connCall;
    const statusEl = document.getElementById('status');
    const meterBar = document.getElementById('meter');

    async function initAudio() {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new AudioContext();
        const analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(localStream);
        source.connect(analyser);
        analyser.fftSize = 256;
        const data = new Uint8Array(analyser.frequencyBinCount);
        (function updateMeter(){
            analyser.getByteFrequencyData(data);
            const avg = data.reduce((a,b)=>a+b)/data.length / 255;
            meterBar.style.width = (avg * 100) + '%';
            requestAnimationFrame(updateMeter);
        })();
    }

    peer.on('open', id => {
        statusEl.textContent = 'Estado: ID de Sala ' + id;
    });

    peer.on('call', call => {
        connCall = call;
        call.answer(localStream);
        statusEl.textContent = 'Estado: Llamada entrante';
        call.on('stream', remoteStream => {
            new Audio(URL.createObjectURL(remoteStream)).play();
            statusEl.textContent = 'Estado: En P2P con ' + call.peer;
        });
    });

    document.getElementById('create-room').onclick = async ()=>{
        await initAudio();
        statusEl.textContent = 'Sala creada: ' + peer.id;
    };

    document.getElementById('join-room').onclick = async ()=>{
        const id = document.getElementById('room-id').value.trim();
        if(!id) { statusEl.textContent = 'Ingrese ID de Sala'; return; }
        if(!localStream) await initAudio();
        connCall = peer.call(id, localStream);
        connCall.on('stream', remoteStream => {
            new Audio(URL.createObjectURL(remoteStream)).play();
            statusEl.textContent = 'Conectado a ' + id;
        });
    };
})();
</script>
</body>
</html>
